(function(){var d=0;var Z=96/72;var A=0.05;var ai=5;var z=YAHOO.util.Dom,Q=YAHOO.util.Event,ac=YAHOO.util.Element;var e=Alfresco.util.encodeHTML;Alfresco.WebPreview.prototype.Plugins.PdfJs=function(aD,aC){this.pages=[];this.pageText=[];this.widgets={};this.documentConfig={};this.wp=aD;this.wp.id=aD.id;this.attributes=YAHOO.lang.merge(Alfresco.util.deepCopy(this.attributes),aC);this.onPdfLoaded=new YAHOO.util.CustomEvent("pdfLoaded",this);this.onResize=new YAHOO.util.CustomEvent("resize",this);return this};Alfresco.WebPreview.prototype.Plugins.PdfJs.prototype={attributes:{src:null,srcMaxSize:"",skipbrowsertest:"false",defaultScale:"auto",scaleDelta:"1.1",autoMinScale:"0.65",autoMinScaleMobile:"0.525",autoMaxScale:"1.25",pageLayout:"multi",disableTextLayer:"false",useLocalStorage:"true",autoSearch:"false",progressiveLoading:"false",disabledPageLinking:true},pdfDocument:null,pageNum:1,pages:[],pageText:[],numPages:0,widgets:{},maximized:false,documentConfig:{},inDashlet:false,workerSrc:"",currentScaleSelection:null,report:function h(){var aC=true,aE=this.attributes.skipbrowsertest==="true",aD=this.attributes.srcMaxSize;if(aD.match(/^\d+$/)&&this.wp.options.size>parseInt(aD)){return this.wp.msg("PdfJs.tooLargeFile",Alfresco.util.formatFileSize(this.wp.options.size),parseInt(aD))}if(!aE){if(this._isCanvasSupported()){if(YAHOO.env.ua.webkit>0&&YAHOO.env.ua.webkit<534){aC=false}if(YAHOO.env.ua.ie>0&&YAHOO.env.ua.ie<10){aC=false}if(YAHOO.env.ua.gecko>0&&YAHOO.env.ua.gecko<5){aC=false}}else{aC=false}}if(!aC){return this.wp.msg("label.browserReport","&lt;canvas&gt; element")}},_isCanvasSupported:function n(){var aC=document.createElement("canvas");return !!(aC.getContext&&aC.getContext("2d"))},display:function Y(){this.inDashlet=z.getAncestorByClassName(this.wp.getPreviewerElement(),"body")!=null||z.getAncestorByClassName(this.wp.getPreviewerElement(),"yui-panel")!=null;Alfresco.util.YUILoaderHelper.require(["tabview"],this.onComponentsLoaded,this);Alfresco.util.YUILoaderHelper.loadComponents();this.wp.getPreviewerElement().innerHTML="";return null},onComponentsLoaded:function f(){this.workerSrc=Alfresco.constants.URL_CONTEXT+"res/components/preview/pdfjs/pdf.worker.js";var aC=document.getElementsByTagName("script");for(var aF=0,aE=aC.length;aF<aE;aF++){if(aC[aF].src.indexOf("components/preview/pdfjs/pdf.worker_")>-1){this.workerSrc=aC[aF].src;break}}this._loadDocumentConfig();this.attributes.disabledPageLinking=(Alfresco.constants.PAGEID==="document-details")?false:true;var aD=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));if(this.disabledPageLinking){this.pageNum=this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum}else{this.pageNum=aD.page||(this.documentConfig.pageNum?parseInt(this.documentConfig.pageNum):this.pageNum)}this.pageNum=parseInt(this.pageNum);Alfresco.util.Ajax.request({url:Alfresco.constants.URL_CONTEXT+"noauth/components/preview/pdfjs?htmlid="+encodeURIComponent(this.wp.id),successCallback:{fn:this.onViewerLoaded,scope:this},failureMessage:this.wp.msg("error.viewerload")});Q.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true);Q.addListener(window,"hashchange",this.onWindowHashChange,this,true);Q.addListener(window,"beforeunload",this.onWindowUnload,this,true)},onViewerLoaded:function p(aI){this.wp.getPreviewerElement().innerHTML=aI.serverResponse.responseText;this.controls=z.get(this.wp.id+"-controls");this.pageNumber=z.get(this.wp.id+"-pageNumber");this.sidebar=z.get(this.wp.id+"-sidebar");this.viewer=z.get(this.wp.id+"-viewer");if(this.attributes.pageLayout=="multi"){z.addClass(this.viewer,"multiPage")}this.widgets.sidebarButton=Alfresco.util.createYUIButton(this,"sidebarBtn",this.onSidebarToggle,{type:"checkbox",disabled:true},this.wp.id+"-sidebarBtn");this.widgets.nextButton=Alfresco.util.createYUIButton(this,"next",this.onPageNext,{disabled:true},this.wp.id+"-next");this.widgets.previousButton=Alfresco.util.createYUIButton(this,"previous",this.onPagePrevious,{disabled:true},this.wp.id+"-previous");Q.addListener(this.wp.id+"-pageNumber","change",this.onPageChange,this,true);this.widgets.zoomOutButton=Alfresco.util.createYUIButton(this,"zoomOut",this.onZoomOut,{disabled:true},this.wp.id+"-zoomOut");this.widgets.zoomInButton=Alfresco.util.createYUIButton(this,"zoomIn",this.onZoomIn,{disabled:true},this.wp.id+"-zoomIn");this.widgets.scaleMenu=new YAHOO.widget.Button(this.wp.id+"-scaleSelectBtn",{type:"menu",menu:this.wp.id+"-scaleSelect",disabled:true});this.widgets.scaleMenu.getMenu().subscribe("click",this.onZoomChange,null,this);var aC=[{text:this.wp.msg("link.download"),value:"",onclick:{fn:this.onDownloadClick,scope:this}}];if(this.attributes.src){aC.push({text:this.wp.msg("link.downloadPdf"),value:"",onclick:{fn:this.onDownloadPDFClick,scope:this}})}this.widgets.downloadButton=new YAHOO.widget.Button(this.wp.id+"-download",{type:"menu",menu:aC});if(Alfresco.constants.PAGEID==="document-details"||Alfresco.constants.PAGEID==="documentlibrary"||window.location.pathname.match("/document-details$")){this.widgets.maximize=Alfresco.util.createYUIButton(this,"fullpage",this.onMaximizeClick,{title:this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-fullpage");z.getElementsByClassName("maximizebutton","span",this.controls,function aH(aJ){z.setStyle(aJ,"display","inline")});z.getElementsByClassName("maximizebuttonSep","span",this.controls,function aH(aJ){z.setStyle(aJ,"display","inline")})}if(Alfresco.constants.PAGEID==="document-details"){z.getElementsByClassName("linkbutton","span",this.controls,function aH(aJ){z.setStyle(aJ,"display","inline")});this.widgets.linkBn=Alfresco.util.createYUIButton(this,"link",this.onLinkClick,{type:"checkbox"},this.wp.id+"-link")}Q.addListener(this.wp.id+"-findInput","change",this.onFindChange,this,true);var aG=this;Q.addListener(this.wp.id+"-findInput","keypress",function(aJ){if(aJ.keyCode==13){Q.stopEvent(aJ);aG.onFindChange("find")}});this.widgets.previousSearchButton=Alfresco.util.createYUIButton(this,"findPrevious",this.onFindChange,{},this.wp.id+"-findPrevious");this.widgets.nextSearchButton=Alfresco.util.createYUIButton(this,"findNext",this.onFindChange,{},this.wp.id+"-findNext");this.widgets.searchHighlight=Alfresco.util.createYUIButton(this,"findHighlightAll",this.onFindChangeHighlight,{type:"checkbox"},this.wp.id+"-findHighlightAll");this.widgets.searchMatchCase=Alfresco.util.createYUIButton(this,"findMatchCase",this.onFindChangeMatchCase,{type:"checkbox"},this.wp.id+"-findMatchCase");this.widgets.searchBarToggle=Alfresco.util.createYUIButton(this,"searchBarToggle",this.onToggleSearchBar,{type:"checkbox",disabled:true,title:this.wp.msg("button.search.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl"))},this.wp.id+"-searchBarToggle");this.onPdfLoaded.subscribe(function aD(aK,aJ){this.widgets.sidebarButton.set("disabled",false);this.widgets.scaleMenu.set("disabled",false);this.widgets.searchBarToggle.set("disabled",false)},this,true);this._setPreviewerElementHeight();this._setViewerHeight();this._loadPdf();if(Alfresco.constants.PAGEID==="document-details"){var aF=function aF(aK,aJ){var aL=aJ[1];if((aL.ctrlKey||aL.metaKey)&&this.widgets.searchBarToggle){Q.stopEvent(aL);aL.newValue=(!this.widgets.searchDialog||!this.widgets.searchDialog.cfg.getProperty("visible"));this.widgets.searchBarToggle.set("checked",!this.widgets.searchBarToggle.get("checked"))}};var aE=function aE(aK,aJ){var aL=aJ[1];if(aL.ctrlKey||aL.metaKey){Q.stopEvent(aL);this.onFullScreen(aL)}};new YAHOO.util.KeyListener(document,{keys:37},{fn:this.onPagePrevious,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:39},{fn:this.onPageNext,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70,ctrl:true},{fn:aF,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:13,ctrl:true},{fn:aE,scope:this,correctScope:true}).enable();if(YAHOO.env.ua.os=="macintosh"){new YAHOO.util.KeyListener(document,{keys:13},{fn:aE,scope:this,correctScope:true}).enable();new YAHOO.util.KeyListener(document,{keys:70},{fn:aF,scope:this,correctScope:true}).enable()}Q.addListener(window,"fullscreenchange",this.onFullScreenChange,this,true);Q.addListener(window,"mozfullscreenchange",this.onFullScreenChange,this,true);Q.addListener(window,"webkitfullscreenchange",this.onFullScreenChange,this,true)}new YAHOO.util.KeyListener(document,{keys:27},{fn:function(aJ){if(this.maximized){this.onMaximizeClick()}},scope:this,correctScope:true}).enable()},_setPreviewerElementHeight:function aj(){if(!this.maximized){var aG;if(this.inDashlet){z.setStyle(this.wp.getPreviewerElement(),"height",(z.getClientHeight()-64)+"px")}else{if(aG=z.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aH=z.getStyle(aG,"height");var aC=(parseInt(aH)-42)+"px";z.setStyle(this.wp.getPreviewerElement(),"height",aC)}else{var aF=new YAHOO.util.Element(this.wp.getPreviewerElement()),aE=z.getDocumentHeight(),aD=z.getClientHeight();var aC=((aE<aD)?aE:aD)-220;z.setStyle(this.wp.getPreviewerElement(),"height",aC+"px")}}}else{if(this.fullscreen){}else{z.setStyle(this.wp.getPreviewerElement(),"height",(window.innerHeight||z.getViewportHeight()).toString()+"px")}}},_setViewerHeight:function ao(){var aF=z.getRegion(this.viewer.parentNode),aK=z.getRegion(this.controls),aC=!this.fullscreen?aK.height:0,aD=aF.height-aC-1;if(aD===0){if(!this.maximized){var aG;if(aG=z.getAncestorByClassName(this.wp.getPreviewerElement(),"dijitDialogPaneContent")){var aH=z.getStyle(aG,"height");var aJ=(parseInt(aH)-42-10-aC-1)+"px";z.setStyle(this.wp.getPreviewerElement(),"height",aJ)}else{var aE=new YAHOO.util.Element(this.wp.getPreviewerElement()),aL=z.getDocumentHeight(),aI=z.getClientHeight();var aJ=((aL<aI)?aL:aI)-220;aD=aJ-10-aC-1}}else{aD=z.getViewportHeight()-aC-1}}if(!this.fullscreen){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to "+aD+"px (toolbar "+aC+"px, container "+aF.height+"px")}z.setStyle(this.viewer,"height",aD.toString()+"px");z.setStyle(this.sidebar,"height",aD.toString()+"px")}else{if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Setting viewer height to 100% (full-screen)")}z.setStyle(this.viewer,"height","100%")}},_loadPdf:function W(aE){this.wp.options.name=this.wp.options.name.replace(/[^\w_\-\. ]/g,"");var aD=this,aC=this.attributes.src?this.wp.getThumbnailUrl(this.attributes.src):this.wp.getContentUrl();if(aC.substr(0,4).toLowerCase()!=="http"){aC=window.location.protocol+"//"+window.location.host+aC}aE=aE||{};aE.url=aC;if(typeof window.Spinner==="function"){this.spinner=new Spinner({lines:13,length:7,width:4,radius:10,corners:1,rotate:0,color:"#666",speed:1,trail:60,shadow:false,hwaccel:false,className:"spinner",zIndex:2000000000,top:"auto",left:"auto"}).spin(this.viewer);this.onPdfLoaded.subscribe(function aF(aH,aG){this.spinner.stop()},this,true)}else{Alfresco.logger.error("spinner.js is not loaded!")}pdfjsLib.GlobalWorkerOptions.workerSrc=this.workerSrc;aE.cMapUrl=Alfresco.constants.URL_CONTEXT+"res/components/preview/pdfjs/cmaps/";aE.cMapPacked=true;if(this.attributes.progressiveLoading=="true"&&aE.disableRange!=true){aE.disableRange=false;aE.disableAutoFetch=false}else{aE.disableRange=true}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Using params.disableRange="+aE.disableRange+" params.disableAutoFetch:"+aE.disableAutoFetch);Alfresco.logger.debug("Loading PDF file from "+aC)}pdfjsLib.getDocument(aE).promise.then(Alfresco.util.bind(this._onGetDocumentSuccess,this),Alfresco.util.bind(this._onGetDocumentFailure,this))},_onGetDocumentSuccess:function al(aC){this.pdfDocument=aC;this.numPages=this.pdfDocument.numPages;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering PDF with fingerprint "+aC.fingerprint+" for "+this.wp.options.name)}this._renderPdf();this._updatePageControls();this.onPdfLoaded.fire(aC)},_onGetDocumentFailure:function ag(aN,aF){if(this.spinner){this.spinner.stop()}if(aF&&aF.name==="PasswordException"){var aH="prompt.password.text";if(aF.code==="incorrectpassword"){aH="error.incorrectpassword"}if(aF.code==="needpassword"||aF.code==="incorrectpassword"){var aG=this,aD=Alfresco.util.generateDomId(),aK=Alfresco.util.bind(function(aO){if(aO&&aO.length>0){this._loadPdf({password:aO})}},this),aE=Alfresco.util.PopupManager.getUserInput({title:this.wp.msg("prompt.password.title"),html:'<label for="'+aD+'">'+e(this.wp.msg(aH))+'</label><br/><br/><input id="'+aD+'" tabindex="0" type="password" value=""/>',buttons:[{text:Alfresco.util.message("button.ok",this.name),handler:function aL(){aK(z.get(aD).value);this.destroy()},isDefault:true},{text:Alfresco.util.message("button.cancel",this.name),handler:function aI(){this.destroy()}}]}),aJ=aE.getButtons()[0];YAHOO.util.Event.addListener(aD,"keyup",function(aO,aP){if(aP!=null){aP.set("disabled",YAHOO.lang.trim(this.value||this.text||"").length==0)}},aJ);new YAHOO.util.KeyListener(aD,{keys:[YAHOO.util.KeyListener.KEY.ENTER]},function aM(aO){aK(z.get(aD).value);aE.destroy()}).enable();if(z.get(aD)){z.get(aD).focus()}return}}var aC=this.wp.msg("error.pdfload");if(aF&&aF.name==="InvalidPDFException"){aC=this.wp.msg("error.invalidpdf")}Alfresco.util.PopupManager.displayMessage({text:aC});if(aF&&aF.name){Alfresco.logger.error("Could not load PDF due to error "+aF.name+" (code "+aF.code+"): "+aN)}},_renderPdf:function ar(){var aF=[],aG={},aC=this.numPages;for(var aI=1;aI<=aC;aI++){aF.push(this.pdfDocument.getPage(aI))}var aL=Promise.all(aF);var aK=this.pdfDocument.getDestinations();var aE=Alfresco.util.bind(function(aS){var aM=this;this.documentView=new I(this.wp.id+"-viewer",{name:"documentView",pageLayout:this.attributes.pageLayout,currentScale:d,defaultScale:this.documentConfig.scale?this.documentConfig.scale:this.attributes.defaultScale,disableTextLayer:this.attributes.disableTextLayer=="true"||YAHOO.env.ua.ios||YAHOO.env.ua.android,autoMinScale:parseFloat(z.getClientWidth()>1024?this.attributes.autoMinScale:this.attributes.autoMinScaleMobile),autoMaxScale:parseFloat(this.attributes.autoMaxScale),pdfJsPlugin:aM,pdfDocument:this.pdfDocument});this.documentView.onScrollChange.subscribe(function aQ(){var aT=this.documentView.getScrolledPageNumber();if(this.pageNum!=aT){this.pageNum=aT;this._updatePageControls();this.documentView.setActivePage(this.pageNum)}},this,true);this.thumbnailView=null;this.pages=aS;this.documentView.addPages(aS);for(var aO=0;aO<aS.length;aO++){var aP=aS[aO],aR=aP.ref;aG[aR.num+" "+aR.gen+" R"]=aO}this.documentView.render();if(this.pageNum>this.pdfDocument.numPages){this.pageNum=this.pdfDocument.numPages;this._updatePageControls()}this.documentView.scrollTo(this.pageNum);this.documentView.setActivePage(this.pageNum);this._updateZoomControls();z.get(this.wp.id+"-numPages").textContent=this.numPages;z.setAttribute(this.wp.id+"-pageNumber","max",this.numPages);z.setAttribute(this.wp.id+"-pageNumber","disabled",this.numPages>1?null:"disabled");z.get(this.wp.id+"-pageNumber").removeAttribute("disabled");if(this.attributes.autoSearch=="true"&&document.referrer&&document.referrer.indexOf("/search?")>0){var aN=Alfresco.util.getQueryStringParameter("t",document.referrer);if(aN){this.widgets.searchBarToggle.set("checked",true);z.get(this.wp.id+"-findInput").value=aN;this.onFindChange("find")}}},this);var aH=Alfresco.util.bind(function(aM){this.destinations=aM},this);var aJ=Alfresco.util.bind(function(aM){this._addOutline(aM)},this);var aD=Alfresco.util.bind(function(){this.pdfDocument.getOutline().then(aJ)},this);aL.then(aE);this.pagesRefMap=aG;aK.then(aH);Promise.all([aL,aK]).then(aD)},_updatePageControls:function ad(){this.pageNumber.value=this.pageNum;this.widgets.nextButton.set("disabled",this.pageNum>=this.pdfDocument.numPages);this.widgets.previousButton.set("disabled",this.pageNum<=1)},_updateZoomControls:function V(aD){var aC=this.documentView.currentScale;this.widgets.zoomInButton.set("disabled",aC*this.attributes.scaleDelta>ai);this.widgets.zoomOutButton.set("disabled",aC/this.attributes.scaleDelta<A);this.widgets.scaleMenu.set("label",""+Math.round(aC*100)+"%")},_scrollToPage:function ab(aC){this.documentView.removeScrollListener();this.documentView.scrollTo(aC);this.documentView.setActivePage(this.pageNum);this.pageNum=aC;this._updatePageControls();if(this.thumbnailView&&this.thumbnailView.pages&&this.thumbnailView.pages[0]&&this.thumbnailView.pages[0].container){this.thumbnailView.setActivePage(this.pageNum)}YAHOO.lang.later(50,this.documentView,this.documentView.addScrollListener)},_addOutline:function ay(aC){var aI=z.get(this.wp.id+"-outlineView");if(aC&&aC.length>0){var aH=[{parent:aI,items:aC}];while(aH.length>0){var aD=aH.shift();var aG,aF=aD.items.length;for(aG=0;aG<aF;aG++){var aL=aD.items[aG];var aE=document.createElement("div");aE.className="outlineItem";var aK=document.createElement("a");z.setAttribute(aK,"href","#");YAHOO.util.Event.addListener(aK,"click",function(aN,aM){YAHOO.util.Event.stopEvent(aN);this._navigateTo(aM)},aL.dest,this);aK.textContent=aL.title;aE.appendChild(aK);if(aL.items.length>0){var aJ=document.createElement("div");aJ.className="outlineItems";aE.appendChild(aJ);aH.push({parent:aJ,items:aL.items})}aD.parent.appendChild(aE)}}}else{aI.innerHTML="<p>"+this.wp.msg("msg.noOutline")+"</p>"}},_navigateTo:function b(aD){if(typeof aD==="string"){aD=this.destinations[aD]}if(aD instanceof Array){var aE=aD[0];var aC=aE instanceof Object?this.pagesRefMap[aE.num+" "+aE.gen+" R"]:(aE+1);if(aC>this.documentView.pages.length-1){aC=this.documentView.pages.length-1}if(typeof aC==="number"){this._scrollToPage(aC+1)}}},_loadDocumentConfig:function av(){if(this.attributes.useLocalStorage!="true"||!this._browserSupportsHtml5Storage()){this.documentConfig={}}else{var aC="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";this.documentConfig={pageNum:window.localStorage[aC+"pageNum"],scale:window.localStorage[aC+"scale"]};if(this.documentConfig.scale=="null"){this.documentConfig.scale=null}}},_browserSupportsHtml5Storage:function az(){try{return"localStorage" in window&&window.localStorage!==null}catch(aC){return false}},onSidebarToggle:function am(aF){var aC=z.getStyle(this.sidebar,"display")=="block";z.setStyle(this.sidebar,"display",aC?"none":"block");if(aC){z.removeClass(this.viewer,"sideBarVisible")}else{z.addClass(this.viewer,"sideBarVisible");if(!this.thumbnailView){this.thumbnailView=new I(this.wp.id+"-thumbnailView",{name:"thumbnailView",pageLayout:"single",defaultScale:"page-width",disableTextLayer:true,pdfJsPlugin:this});this.thumbnailView.addPages(this.pages)}}this.documentView.alignRows();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.renderVisiblePages();var aE=function aE(aH,aG){YAHOO.util.Event.stopEvent(aH);this._scrollToPage(aG.pn)};this.widgets.tabview=this.widgets.tabview||new YAHOO.widget.TabView(this.wp.id+"-sidebarTabView");if(this.thumbnailView&&this.thumbnailView.pages.length>0&&!this.thumbnailView.pages[0].container){this.thumbnailView.render();for(var aD=0;aD<this.thumbnailView.pages.length;aD++){YAHOO.util.Event.addListener(this.thumbnailView.pages[aD].container,"click",function(aH,aG){this.thumbnailView.setActivePage(aG.pn);this.documentView.scrollTo(aG.pn)},{pn:aD+1},this)}this.thumbnailView.scrollTo(this.pageNum);this.thumbnailView.setActivePage(this.pageNum)}},onPagePrevious:function k(aC){if(this.pageNum<=1){return}this.pageNum--;this._scrollToPage(this.pageNum)},onPageNext:function M(aC){if(this.pageNum<this.pdfDocument.numPages){this.pageNum++;this._scrollToPage(this.pageNum)}},onFullScreen:function U(aD){var aC=this.viewer;if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){Q.removeListener(window,"resize",this.onRecalculatePreviewLayout,this,true);if(aC.requestFullScreen){aC.requestFullScreen()}else{if(aC.mozRequestFullScreen){aC.mozRequestFullScreen()}else{if(aC.webkitRequestFullScreen){aC.webkitRequestFullScreen(ac.ALLOW_KEYBOARD_INPUT)}}}}else{if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}}}}},onFullScreenChange:function a(aC){if(aC.type&&aC.type.indexOf("attrmodified-"===0)){}else{if((document.fullScreenElement&&document.fullScreenElement!==null)||(!document.mozFullScreenElement&&!document.webkitFullScreenElement&&!document.webkitFullscreenElement)){Alfresco.logger.debug("Leaving full screen mode");this.fullscreen=false;this.documentView.fullscreen=false;this.documentView.setScale(this.oldScale);this._setViewerHeight();this.onResize.fire();this.documentView.alignRows();this._scrollToPage(this.pageNum);Q.addListener(window,"resize",this.onRecalculatePreviewLayout,this,true)}else{Alfresco.logger.debug("Entering full screen mode");this.documentView.fullscreen=true;this.fullscreen=true;this.oldScale=this.documentView.currentScale;this.oldPageNum=this.pageNum;this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale("page-fit"));this.documentView.alignRows();this._scrollToPage(this.pageNum)}}},onPageChange:function ax(aD){var aC=parseInt(aD.currentTarget.value);if(aC<1||aC>this.numPages){Alfresco.util.PopupManager.displayMessage({text:this.wp.msg("error.badpage")})}else{this.pageNum=aC;this._scrollToPage(this.pageNum)}},onToggleSearchBar:function O(aD){if(!this.widgets.searchDialog){this.widgets.searchDialog=new YAHOO.widget.SimpleDialog(this.wp.id+"-searchDialog",{close:false,draggable:false,effect:null,modal:false,visible:false,width:"265px",context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],underlay:"none"});this.widgets.searchDialog.render();new YAHOO.util.KeyListener(z.get(this.wp.id+"-searchDialog"),{keys:27},{fn:function(aF,aE){if(this.widgets.searchBarToggle.get("checked")){var aG=aE[1];Q.stopEvent(aG);this.widgets.searchBarToggle.set("checked",false)}},scope:this,correctScope:true}).enable()}if(this.widgets.linkBn&&this.widgets.linkBn.get("checked")===true){this.widgets.linkBn.set("checked",false)}if(aD.newValue===true){this.widgets.searchDialog.show();this.widgets.searchDialog.bringToTop();var aC=z.get(this.wp.id+"-findInput");aC.focus();aC.select();if(!q.pdfPageSource){q.initialize({pdfPageSource:this.documentView});q.resolveFirstPage()}q.reset();q.extractText()}else{this.widgets.searchDialog.hide();q.active=false}},onFindChangeMatchCase:function i(aC){this.onFindChange("casesensitivitychange")},onFindChangeHighlight:function v(aC){this.onFindChange("highlightallchange")},onFindChange:function at(aJ){var aI=z.get(this.wp.id+"-findInput").value;if(!aI){return}var aH=document.createEvent("CustomEvent"),aG=false,aF="find",aE=this.widgets.searchHighlight.get("checked"),aC=this.widgets.searchMatchCase.get("checked"),aD;if(aJ.currentTarget){aD=aJ.currentTarget.id}else{aD=aJ}switch(aD){case this.wp.id+"-findNext":aF+="again";break;case this.wp.id+"-findPrevious":aF+="again";aG=true;break;case"highlightallchange":aF+="highlightallchange";break;case"casesensitivitychange":aF+="casesensitivitychange";break;default:if(aI===this.lastSearchQuery){aF+="again";break}else{break}}this.lastSearchQuery=aI;aH.initCustomEvent(aF,true,true,{query:aI,caseSensitive:aC,highlightAll:aE,findPrevious:aG});window.dispatchEvent(aH)},onZoomOut:function r(aD){var aC=Math.max(A,this.documentView.currentScale/this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aC));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomIn:function R(aD){var aC=Math.min(ai,this.documentView.currentScale*this.attributes.scaleDelta);this.documentView.setScale(this.documentView.parseScale(aC));this._scrollToPage(this.pageNum);this._updateZoomControls()},onZoomChange:function c(aE,aD){var aC=aD[0],aF=aD[1];this.currentScaleSelection=aF.value;this.documentView.setScale(this.documentView.parseScale(aF.value));this._scrollToPage(this.pageNum);this._updateZoomControls()},onDownloadClick:function an(aC){this.downloadIfLoggedIn(this.wp.getContentUrl(true).replace("api/node","slingshot/node"))},onDownloadPDFClick:function X(aD){const aC=this.wp.getThumbnailUrl(this.attributes.src)+"&a=true";window.open(aC,"_blank");this.downloadIfLoggedIn(aC,this.wp.options.name)},downloadIfLoggedIn:function D(aC,aE){var aD=new XMLHttpRequest();aD.onreadystatechange=function(){if(this.status===401){window.location.reload()}else{if(this.readyState==4&&this.status==200){const aF=document.createElement("a");aF.href=aC;aF.download=aE+".pdf";document.body.appendChild(aF);aF.click();document.body.removeChild(aF)}}};aD.open("GET",aC,true);aD.send()},onMaximizeClick:function y(aC){this.maximized=!this.maximized;if(this.maximized){z.addClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.minimize"));this.widgets.maximize.set("title",this.wp.msg("button.minimize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}else{z.removeClass(this.wp.getPreviewerElement(),"fullPage");this.widgets.maximize.set("label",this.wp.msg("button.maximize"));this.widgets.maximize.set("title",this.wp.msg("button.maximize.tip",YAHOO.env.ua.os=="macintosh"?this.wp.msg("key.meta"):this.wp.msg("key.ctrl")))}this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages();if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}if(this.widgets.searchDialog){this.widgets.searchDialog.align("tr","tr")}if(this.widgets.linkDialog){this.widgets.linkDialog.align("tr","tr")}},onLinkClick:function g(aJ){var aI=this.wp.id+"-linkDialog",aG=aI+"-input";var aC=function aD(){var aN=this.widgets.linkDialogBg.get("checkedButton").get("id");var aM=window.location.href.replace(window.location.hash,"")+(aN.indexOf("-doc")>0?"":"#page="+this.pageNum);var aL=z.get(aG);aL.value=aM;aL.focus();aL.select()};if(!this.widgets.linkDialog){var aK=new YAHOO.widget.SimpleDialog(aI,{close:false,draggable:false,effect:null,modal:false,visible:false,context:[this.viewer,"tr","tr",["beforeShow","windowResize"],[-20,3]],width:"40em",underlay:"none"});var aE=window.location.href.replace(window.location.hash,"")+"#page="+this.pageNum;aK.render();new YAHOO.util.KeyListener(z.get(aI),{keys:27},{fn:function(aM,aL){if(this.widgets.linkBn.get("checked")){var aN=aL[1];Q.stopEvent(aN);this.widgets.linkBn.set("checked",false)}},scope:this,correctScope:true}).enable();var aH=new YAHOO.widget.ButtonGroup(aI+"-bg");for(var aF=0;aF<aH.getCount();aF++){aH.getButton(aF).addListener("click",aC,null,this)}this.widgets.linkDialogBg=aH;this.widgets.linkDialog=aK;YAHOO.util.Event.addListener(aG,"click",function(){this.focus();this.select()})}if(this.widgets.searchBarToggle.get("checked")===true){this.widgets.searchBarToggle.set("checked",false)}if(!this.widgets.linkDialog.cfg.getProperty("visible")){this.widgets.linkDialog.show();this.widgets.linkDialog.bringToTop();aC.call(this)}else{this.widgets.linkDialog.hide()}},onRecalculatePreviewLayout:function aq(aC){if(this.documentView){Alfresco.logger.debug("onRecalculatePreviewLayout");this._setPreviewerElementHeight();this._setViewerHeight();this.onResize.fire();this.documentView.setScale(this.documentView.parseScale(this.currentScaleSelection?this.currentScaleSelection:this.attributes.defaultScale));this._scrollToPage(this.pageNum);this.documentView.alignRows();this.documentView.renderVisiblePages()}if(this.thumbnailView){this.thumbnailView.renderVisiblePages()}},onWindowHashChange:function N(aD){if(this.disabledPageLinking){return}var aC=Alfresco.util.getQueryStringParameters(window.location.hash.replace("#",""));pn=aC.page;if(pn){if(pn>this.pdfDocument.numPages){pn=this.pdfDocument.numPages}else{if(pn<1){pn=1}}this.pageNum=parseInt(pn);this._scrollToPage(this.pageNum)}},onWindowUnload:function o(){if(this.attributes.useLocalStorage=="true"&&this._browserSupportsHtml5Storage()&&this.documentView){var aC="org.alfresco.pdfjs.document."+this.wp.options.nodeRef.replace(":/","").replace("/",".")+".";if(this.pageNum){window.localStorage[aC+"pageNum"]=this.pageNum}if(this.documentView.lastScale){window.localStorage[aC+"scale"]=this.documentView.lastScale}if(this.widgets.sidebarButton){window.localStorage[aC+"sidebar-enabled"]=this.widgets.sidebarButton.get("checked")}}}};var t=function(aG,aF,aE,aD,aC){this.id=aG;this.content=aF;this.parent=aE;this.canvas=null;this.container=null;this.loadingIconDiv=null;this.textLayerDiv=null;this.config=aD||{};this.textContent=null;this.textLayerDiv=null;this.pdfJsPlugin=aC};t.prototype={render:function B(){var aD=document.createElement("div");aD.id=this.parent.id+"-pageContainer-"+this.id;z.addClass(aD,"page");this.parent.viewer.appendChild(aD);var aC=document.createElement("div");z.addClass(aC,"loadingIcon");aD.appendChild(aC);this.container=aD;this.loadingIconDiv=aC;this._setPageSize()},getRegion:function j(){return z.getRegion(this.container)},getVPos:function ah(aC){return this.container.getBoundingClientRect().top+z.getDocumentScrollTop()-this.parent.viewerRegion.top},renderContent:function s(){var aN=this.getRegion(),aD=document.createElement("canvas"),aF={scale:this.parent.currentScale};aD.id=this.container.id.replace("-pageContainer-","-canvas-");aD.mozOpaque=true;this.container.appendChild(aD);this.canvas=aD;z.setStyle(aD,"visibility","hidden");aD.width=aN.width;aD.height=aN.height;var aL=this.content.getViewport(aF);var aH=null;if(!this.parent.config.disableTextLayer){aH=document.createElement("div");aH.className="textLayer";this.container.appendChild(aH)}this.textLayerDiv=aH;this.textLayer=aH?new ak(aH,this.id-1,this.pdfJsPlugin,aL):null;var aK=this.content,aO=aK.view,aP=aD.getContext("2d");var aE={canvasContext:aP,viewport:aL,textLayer:this.textLayer};var aC=0;if(Alfresco.logger.isDebugEnabled()){aC=Date.now()}var aG=Alfresco.util.bind(function aI(aQ){this.textLayer.setTextContent(aQ)},this);var aJ=Alfresco.util.bind(function aM(){if(this.textLayer){this.getTextContent().then(aG)}if(this.loadingIconDiv){z.setStyle(this.loadingIconDiv,"display","none")}z.setStyle(this.canvas,"visibility","visible");if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendered "+this.parent.name+" page "+this.id+" in "+(Date.now()-aC)+"ms")}},this);aK.render(aE).promise.then(aJ)},_setPageSize:function G(aC){var aE={scale:this.parent.currentScale},aD=this.content.getViewport(aE);z.setStyle(this.container,"height",Math.floor(aD.height)+"px");z.setStyle(this.container,"width",Math.floor(aD.width)+"px")},reset:function m(){this._setPageSize();if(this.canvas){this.container.removeChild(this.canvas);delete this.canvas;this.canvas=null}if(this.loadingIconDiv){z.setStyle(this.loadingIconDiv,"display","block")}},getTextContent:function F(){if(!this.textContent){this.textContent=this.content.getTextContent()}return this.textContent},scrollIntoView:function C(aD,aC){var aE=0;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll")}if(aD){aE+=aD.offsetTop;if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll offsetTop "+aD.offsetTop)}}if(aC){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll spot "+aC.top)}aE+=aC.top}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Page Scroll "+aE)}this.parent.scrollTo(this.id,aE)}};var I=function(aE,aD){this.id=aE;this.config=aD||{};this.pages=[];this.viewer=z.get(aE);this.viewerRegion=z.getRegion(this.viewer);this.currentScale=aD.currentScale||d;this.name=this.config.name||"";this.pdfJsPlugin=aD.pdfJsPlugin;this.pdfDocument=aD.pdfDocument;this.lastScroll=0;var aC=this;this.viewer.addEventListener("scroll",function(){aC.lastScroll=Date.now()},false);this.pdfJsPlugin.onResize.subscribe(this.onResize,this,true);this.addScrollListener();this.onScrollChange=new YAHOO.util.CustomEvent("scrollChange",this)};I.prototype={activePage:null,lastScale:null,renderOnScrollZero:0,addPage:function E(aE,aC){var aD=new t(aE,aC,this,{},this.pdfJsPlugin);this.pages.push(aD)},addPages:function J(aC){for(var aD=0;aD<aC.length;aD++){var aE=aC[aD];this.addPage(aD+1,aE)}},render:function P(){for(var aC=0;aC<this.pages.length;aC++){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page container "+(aC+1))}this.pages[aC].render()}if(this.currentScale===d){this.setScale(this.parseScale(this.config.defaultScale))}else{this.alignRows()}},reset:function aw(){for(var aC=0;aC<this.pages.length;aC++){this.pages[aC].reset()}this.alignRows()},alignRows:function aA(){var aC=-1,aF=0,aG=0,aJ=z.getDocumentScrollTop();if(this.config.pageLayout=="multi"){z.setStyle(this.viewer,"padding-left","0px");for(var aH=0;aH<this.pages.length;aH++){var aI=this.pages[aH],aD=aI.container,aK=aD.getBoundingClientRect(),aL=aK.top+aJ-aI.parent.viewerRegion.top,aE=parseInt(z.getStyle(aD,"margin-left"));if(aL!=aC){aF=aE}aF+=aK.width+aE;aG=Math.max(aG,aF);aC=aL}z.setStyle(this.viewer,"padding-left",Math.floor((this.viewer.clientWidth-aG)/2)+"px")}},renderVisiblePages:function w(){this.viewerRegion=z.getRegion(this.viewer);var aK=this.viewerRegion.height,aJ=this.viewerRegion.top,aI=z.getDocumentScrollTop();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Render "+this.name+" visible pages: viewer height "+this.viewerRegion.height+"px")}for(var aE=0;aE<this.pages.length;aE++){var aG=this.pages[aE];if(!aG.canvas){var aD=aG.container.getBoundingClientRect(),aH=aD.top+aI-aJ,aC=aH+aD.height,aF=1.5;if(aH<0&&0<aC||-aK*aF<aC&&aC<aK||0<aH&&aH<aK*(aF+1)){if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Rendering "+this.name+" page "+(aE+1)+" content (page top:"+aH+", bottom:"+aC+")")}aG.renderContent()}}}},scrollTo:function u(aG,aF){var aC=this.pages[aG-1].getVPos(),aE=this.pages[0].getVPos();if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scrolling "+this.name+" to page "+aG+". New page top is "+aC+"px. First page top is "+aE+"px")}var aD=aC-aE;if(aF){aD+=aF}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Old scrollTop was "+this.viewer.scrollTop+"px");Alfresco.logger.debug("Set scrollTop to "+aD+"px");Alfresco.logger.debug("scrollTop offsetY "+aF)}this.viewer.scrollTop=aD;this.pageNum=aG;this.renderVisiblePages()},setScale:function af(aC){if(aC==this.currentScale){return}if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Scale is now "+aC)}this.currentScale=aC;this.reset();this.alignRows()},parseScale:function aa(aM){var aU=parseFloat(aM);if(aU){this.lastScale=aM;return aU}if(this.pages.length!==0){var aP=this.pages[0],aK=aP.container,aH=parseInt(z.getStyle(aK,"margin-left"))+parseInt(z.getStyle(aK,"margin-right")),aJ=parseInt(z.getStyle(aK,"margin-top")),aL=parseInt(aP.content.view[2]),aO=parseInt(aP.content.view[3]),aN=aP.content.rotate,aR=this.fullscreen?window.screen.width:this.viewer.clientWidth-1,aG=this.fullscreen?window.screen.height:this.viewer.clientHeight;Alfresco.logger.debug("Client height: "+this.viewer.clientHeight);if(aN===90||aN===270){var aT=aL;aL=aO;aO=aT}switch(aM){case"page-width":var aD=(aR-aH*2)/aL;aU=aD;break;case"two-page-width":var aD=(aR-aH*3)/aL;aU=aD/2;break;case"page-height":var aC=(aG-aJ*2)/aO;aU=aC;break;case"page-fit":var aD=(aR-aH*2)/aL,aC=(aG-aJ*2)/aO;aU=Math.min(aD,aC);break;case"two-page-fit":var aD=(aR-aH*3)/aL,aC=(aG-aJ*2)/aO;aU=Math.min(aD/2,aC);break;case"auto":var aE=this.parseScale("two-page-fit"),aI=this.parseScale("page-fit"),aV=this.parseScale("page-width"),aQ=this.parseScale("two-page-width"),aS=this.config.autoMinScale,aF=this.config.autoMaxScale;if(aE>aS&&this.numPages>1){aU=aE}else{if(aI>aS){aU=aI}else{if(aQ>aS&&this.numPages>1){aU=aQ}else{aU=aV}}}if(aF){aU=Math.min(aU,aF)}break;default:throw"Unrecognised zoom level '"+aM+"'"}}else{throw"Unrecognised zoom level - no pages"}this.lastScale=aM;return aU},getScrolledPageNumber:function L(){for(var aC=0;aC<this.pages.length;aC++){var aD=this.pages[aC],aE=aD.getVPos();if(aE+parseInt(aD.container.style.height)/2>0){return aC+1}}return this.pages.length},setActivePage:function l(aC){if(this.activePage){z.removeClass(this.activePage.container,"activePage")}z.addClass(this.pages[aC-1].container,"activePage");this.activePage=this.pages[aC-1]},onResize:function H(){this.viewerRegion=z.getRegion(this.viewer)},addScrollListener:function x(){Q.addListener(this.viewer,"scroll",this.onScrollEvent,this,true)},removeScrollListener:function x(){Q.removeListener(this.viewer,"scroll",this.onScrollEvent)},onScrollEvent:function au(aC){this.renderOnScrollZero++;YAHOO.lang.later(50,this,this.onScroll,aC)},onScroll:function aB(aC){this.renderOnScrollZero--;if(this.renderOnScrollZero==0){this.renderVisiblePages();this.onScrollChange.fire(this)}}};var T=-50;var K=-400;var ak=function S(aI,aC,aL,aM){var aJ=document.createDocumentFragment();this.textDivs=[];this.viewport=aM;this.textLayerDiv=aI;this.layoutDone=false;this.divContentDone=false;this.pageIdx=aC;this.matches=[];this.pdfJsPlugin=aL;this.isViewerInPresentationMode=false;if(typeof q==="undefined"){window.PDFFindController=null}if(typeof this.lastScrollSource==="undefined"){this.lastScrollSource=null}this.renderLayer=function aH(){var aU=this.textDivs;var aP=document.createElement("canvas");var aY=aP.getContext("2d");var aR=100000;if(aU.length>aR){return}for(var aT=0,aW=aU.length;aT<aW;aT++){var aS=aU[aT];if("isWhitespace" in aS.dataset){continue}aY.font=aS.style.fontSize+" "+aS.style.fontFamily;var aO=aY.measureText(aS.textContent).width;if(aO>0){aJ.appendChild(aS);var aV=aS.dataset.canvasWidth/aO;var aX=aS.dataset.angle;var aQ="scale("+aV+", 1)";aQ="rotate("+aX+"deg) "+aQ;z.setStyle(aS,"-ms-transform","scale("+aV+", 1)");z.setStyle(aS,"-webkit-transform","scale("+aV+", 1)");z.setStyle(aS,"-moz-transform","scale("+aV+", 1)");z.setStyle(aS,"-ms-transformOrigin","0% 0%");z.setStyle(aS,"-webkit-transformOrigin","0% 0%");z.setStyle(aS,"-moz-transformOrigin","0% 0%")}}this.textLayerDiv.appendChild(aJ);this.renderingDone=true;this.updateMatches()};this.setupRenderLayoutTimer=function aN(){var aQ=200;var aO=this;var aP=(this.lastScrollSource===null?0:this.lastScrollSource.lastScroll);if(Date.now()-aP>aQ){this.renderLayer()}else{if(this.renderTimer){clearTimeout(this.renderTimer)}this.renderTimer=setTimeout(function(){aO.setupRenderLayoutTimer()},aQ)}};this.appendText=function aD(aR,aU){var aS=aU[aR.fontName];var aP=document.createElement("div");this.textDivs.push(aP);if(!/\S/.test(aR.str)){aP.dataset.isWhitespace=true;return}var aO=pdfjsLib.Util.transform(this.viewport.transform,aR.transform);var aV=Math.atan2(aO[1],aO[0]);if(aS.vertical){aV+=Math.PI/2}var aT=Math.sqrt((aO[2]*aO[2])+(aO[3]*aO[3]));var aQ=(aS.ascent?aS.ascent*aT:(aS.descent?(1+aS.descent)*aT:aT));aP.style.position="absolute";aP.style.left=(aO[4]+(aQ*Math.sin(aV)))+"px";aP.style.top=(aO[5]-(aQ*Math.cos(aV)))+"px";aP.style.fontSize=aT+"px";aP.style.fontFamily=aS.fontFamily;aP.textContent=aR.str;aP.dataset.fontName=aR.fontName;aP.dataset.angle=aV*(180/Math.PI);if(aS.vertical){aP.dataset.canvasWidth=aR.height*this.viewport.scale}else{aP.dataset.canvasWidth=aR.width*this.viewport.scale}};this.setTextContent=function aK(aQ){this.textContent=aQ;var aP=aQ.items;for(var aO=0;aO<aP.length;aO++){this.appendText(aP[aO],aQ.styles)}this.divContentDone=true;this.setupRenderLayoutTimer()};this.convertMatches=function aE(aU){var aS=0;var aV=0;var aO=this.textContent.items;var aR=aO.length-1;var aQ=(q===null?0:q.state.query.length);var aW=[];for(var aP=0;aP<aU.length;aP++){var aX=aU[aP];while(aS!==aR&&aX>=(aV+aO[aS].str.length)){aV+=aO[aS].str.length;aS++}if(aS==aO.length){console.error("Could not find matching mapping")}var aT={begin:{divIdx:aS,offset:aX-aV}};aX+=aQ;while(aS!==aR&&aX>(aV+aO[aS].str.length)){aV+=aO[aS].str.length;aS++}aT.end={divIdx:aS,offset:aX-aV};aW.push(aT)}return aW};this.renderMatches=function aG(aO){if(aO.length===0){return}var a3=this.textContent.items;var aY=this.textDivs;var aP=null;var a0=(q===null?false:(this.pageIdx===q.selected.pageIdx));var a4=(q===null?-1:q.selected.matchIdx);var a5=(q===null?false:q.state.highlightAll);var aV={divIdx:-1,offset:undefined};function a8(ba,a9){var bb=ba.divIdx;var bc=aY[bb];bc.textContent="";aR(bb,0,ba.offset,a9)}function a6(bb,ba,a9){aR(bb.divIdx,bb.offset,ba.offset,a9)}function aR(bf,ba,a9,bc){var bg=aY[bf];var be=a3[bf].str.substring(ba,a9);var bd=document.createTextNode(be);if(bc){var bb=document.createElement("span");bb.className=bc;bb.appendChild(bd);bg.appendChild(bb);return}bg.appendChild(bd)}function aS(ba,a9){aY[ba].className=a9}var a1=a4,aZ=a1+1,a2;if(a5){a1=0;aZ=aO.length}else{if(!a0){return}}for(a2=a1;a2<aZ;a2++){var aT=aO[a2];var a7=aT.begin;var aQ=aT.end;var aU=a0&&a2===a4;var aX=(aU?" selected":"");if(aU&&!this.isViewerInPresentationMode){this.pdfJsPlugin.documentView.pages[this.pageIdx].scrollIntoView(aY[a7.divIdx],{top:T,left:K})}if(!aP||a7.divIdx!==aP.divIdx){if(aP!==null){a6(aP,aV)}a8(a7)}else{a6(aP,a7)}if(a7.divIdx===aQ.divIdx){a6(a7,aQ,"highlight"+aX)}else{a6(a7,aV,"highlight begin"+aX);for(var aW=a7.divIdx+1;aW<aQ.divIdx;aW++){aS(aW,"highlight middle"+aX)}a8(aQ,"highlight end"+aX)}aP=aQ}if(aP){a6(aP,aV)}};this.updateMatches=function aF(){if(!this.renderingDone){return}var aT=this.matches;var aV=this.textDivs;var aP=this.textContent.items;var aW=-1;for(var aS=0;aS<aT.length;aS++){var aU=aT[aS];var aR=Math.max(aW,aU.begin.divIdx);for(var aQ=aR;aQ<=aU.end.divIdx;aQ++){var aO=aV[aQ];aO.textContent=aP[aQ].str;aO.className=""}aW=aU.end.divIdx+1}if(q===null||!q.active){return}this.matches=aT=(this.convertMatches(q===null?[]:(q.pageMatches[this.pageIdx]||[])));this.renderMatches(this.matches)}};var ap={FIND_FOUND:0,FIND_NOTFOUND:1,FIND_WRAPPED:2,FIND_PENDING:3};var q={startedTextExtraction:false,extractTextPromises:[],pendingFindMatches:{},active:false,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,state:null,dirtyMatch:false,findTimeout:null,pdfPageSource:null,integratedFind:false,initialize:function(aC){this.pdfPageSource=aC.pdfPageSource;this.integratedFind=aC.integratedFind;var aE=["find","findagain","findhighlightallchange","findcasesensitivitychange"];this.firstPagePromise=new Promise(function(aF){this.resolveFirstPage=aF}.bind(this));this.handleEvent=this.handleEvent.bind(this);for(var aD=0;aD<aE.length;aD++){window.addEventListener(aE[aD],this.handleEvent)}},reset:function ae(){this.startedTextExtraction=false;this.extractTextPromises=[];this.active=false},calcFindMatch:function(aD){var aG=this.pageContents[aD];var aI=this.state.query;var aE=this.state.caseSensitive;var aC=aI.length;if(aC===0){return}if(!aE){aG=aG.toLowerCase();aI=aI.toLowerCase()}var aH=[];var aF=-aC;while(true){aF=aG.indexOf(aI,aF+aC);if(aF===-1){break}aH.push(aF)}this.pageMatches[aD]=aH;this.updatePage(aD);if(this.resumePageIdx===aD){this.resumePageIdx=null;this.nextPageMatch()}},extractText:function(){if(this.startedTextExtraction){return}this.startedTextExtraction=true;this.pageContents=[];var aG=[];for(var aD=0,aE=this.pdfPageSource.pdfDocument.numPages;aD<aE;aD++){this.extractTextPromises.push(new Promise(function(aH){aG.push(aH)}))}var aC=this;function aF(aH){aC.pdfPageSource.pages[aH].getTextContent().then(function aI(aL){var aK=aL.items;var aM="";for(var aJ=0;aJ<aK.length;aJ++){aM+=aK[aJ].str}aC.pageContents.push(aM);aG[aH](aH);if((aH+1)<aC.pdfPageSource.pages.length){aF(aH+1)}})}aF(0)},handleEvent:function(aC){if(this.state===null||aC.type!=="findagain"){this.dirtyMatch=true}this.state=aC.detail;this.updateUIState(ap.FIND_PENDING);this.firstPagePromise.then(function(){this.extractText();clearTimeout(this.findTimeout);if(aC.type==="find"){this.findTimeout=setTimeout(this.nextMatch.bind(this),250)}else{this.nextMatch()}}.bind(this))},updatePage:function(aC){var aD=this.pdfPageSource.pages[aC];if(this.selected.pageIdx===aC){aD.scrollIntoView()}if(aD.textLayer){aD.textLayer.updateMatches()}},nextMatch:function(){var aF=this.state.findPrevious;var aI=this.pdfPageSource.pageNum-1;var aD=this.pdfPageSource.pages.length;this.active=true;if(this.dirtyMatch){this.dirtyMatch=false;this.selected.pageIdx=this.selected.matchIdx=-1;this.offset.pageIdx=aI;this.offset.matchIdx=null;this.hadMatch=false;this.resumePageIdx=null;this.pageMatches=[];var aC=this;for(var aE=0;aE<aD;aE++){this.updatePage(aE);if(!(aE in this.pendingFindMatches)){this.pendingFindMatches[aE]=true;this.extractTextPromises[aE].then(function(aJ){delete aC.pendingFindMatches[aJ];aC.calcFindMatch(aJ)})}}}if(this.state.query===""){this.updateUIState(ap.FIND_FOUND);return}if(this.resumePageIdx){return}var aH=this.offset;if(aH.matchIdx!==null){var aG=this.pageMatches[aH.pageIdx].length;if((!aF&&aH.matchIdx+1<aG)||(aF&&aH.matchIdx>0)){this.hadMatch=true;aH.matchIdx=aF?aH.matchIdx-1:aH.matchIdx+1;this.updateMatch(true);return}this.advanceOffsetPage(aF)}this.nextPageMatch()},matchesReady:function(aE){var aF=this.offset;var aD=aE.length;var aC=this.state.findPrevious;if(aD){this.hadMatch=true;aF.matchIdx=aC?aD-1:0;this.updateMatch(true);return true}else{this.advanceOffsetPage(aC);if(aF.wrapped){aF.matchIdx=null;if(!this.hadMatch){this.updateMatch(false);return true}}return false}},nextPageMatch:function(){if(this.resumePageIdx!==null){console.error("There can only be one pending page.")}do{var aC=this.offset.pageIdx;var aD=this.pageMatches[aC];if(!aD){this.resumePageIdx=aC;break}}while(!this.matchesReady(aD))},advanceOffsetPage:function(aD){var aE=this.offset;var aC=this.extractTextPromises.length;aE.pageIdx=aD?aE.pageIdx-1:aE.pageIdx+1;aE.matchIdx=null;if(aE.pageIdx>=aC||aE.pageIdx<0){aE.pageIdx=aD?aC-1:0;aE.wrapped=true;return}},updateMatch:function(aF){var aE=ap.FIND_NOTFOUND;var aD=this.offset.wrapped;this.offset.wrapped=false;if(aF){var aC=this.selected.pageIdx;this.selected.pageIdx=this.offset.pageIdx;this.selected.matchIdx=this.offset.matchIdx;aE=aD?ap.FIND_WRAPPED:ap.FIND_FOUND;if(aC!==-1&&aC!==this.selected.pageIdx){this.updatePage(aC)}}this.updateUIState(aE,this.state.findPrevious);if(this.selected.pageIdx!==-1){this.updatePage(this.selected.pageIdx,true)}},updateUIState:function(aF,aE){var aC="";var aD="";if(aF===ap.FIND_FOUND||aF===ap.FIND_PENDING){return}switch(aF){case ap.FIND_FOUND:aC=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.found");break;case ap.FIND_PENDING:aC=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.pending");break;case ap.FIND_NOTFOUND:aC=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.notfound");break;case ap.FIND_WRAPPED:if(aE){aC=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.bottom")}else{aC=this.pdfPageSource.pdfJsPlugin.wp.msg("search.message.wrapped.top")}break}Alfresco.util.PopupManager.displayMessage({text:aC})}}})();