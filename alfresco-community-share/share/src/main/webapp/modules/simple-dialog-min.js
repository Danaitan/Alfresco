(function(){var k=YAHOO.util.Dom,a=YAHOO.util.Selector,e=YAHOO.util.KeyListener;Alfresco.module.SimpleDialog=function(p,q){q=YAHOO.lang.isArray(q)?q:[];this.isFormOwner=false;if(p!=="null"){this.formsServiceDeferred=new Alfresco.util.Deferred(["onTemplateLoaded","onBeforeFormRuntimeInit"],{fn:this._showDialog,scope:this});YAHOO.Bubbling.on("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this)}return Alfresco.module.SimpleDialog.superclass.constructor.call(this,"Alfresco.module.SimpleDialog",p,["button","container","connection","json","selector"].concat(q))};YAHOO.extend(Alfresco.module.SimpleDialog,Alfresco.component.Base,{dialog:null,form:null,isFormOwner:null,options:{templateUrl:null,actionUrl:null,firstFocus:null,onSuccess:{fn:null,obj:null,scope:window},onSuccessMessage:"",onFailure:{fn:null,obj:null,scope:window},onFailureMessage:"",doBeforeDialogShow:{fn:null,obj:null,scope:null},doSetupFormsValidation:{fn:null,obj:null,scope:null},doBeforeFormSubmit:{fn:null,obj:null,scope:window},doBeforeAjaxRequest:{fn:null,obj:null,scope:window},width:"30em",zIndex:null,clearForm:false,destroyOnHide:false},show:function c(){if(this.dialog){this._showDialog()}else{var p={htmlid:this.id};if(this.options.templateRequestParams){p=YAHOO.lang.merge(this.options.templateRequestParams,p)}Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:p,successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load dialog template from '"+this.options.templateUrl+"'.",scope:this,execScripts:true})}return this},_showDialog:function f(){var p=k.get(this.id+"-form");k.addClass(p,"bd");var y=this.options.doSetupFormsValidation;if(typeof y.fn=="function"){y.fn.call(y.scope||this,this.form,y.obj)}var r=this.options.doBeforeFormSubmit;if(typeof r.fn=="function"){this.form.doBeforeFormSubmit=r}else{this.form.doBeforeFormSubmit={fn:function q(){this.widgets.cancelButton.set("disabled",true)},scope:this}}var t=this.options.doBeforeAjaxRequest;if(typeof t.fn=="function"){this.form.doBeforeAjaxRequest=t}if(this.options.actionUrl!==null){p.attributes.action.nodeValue=this.options.actionUrl}if(this.options.clearForm){var v=a.query("input",p),w;v=v.concat(a.query("textarea",p));for(var u=0,s=v.length;u<s;u++){w=v[u];if(w.getAttribute("type")!="radio"&&w.getAttribute("type")!="checkbox"&&w.getAttribute("type")!="hidden"){w.value=""}}}var x=this.options.doBeforeDialogShow;if(x&&typeof x.fn=="function"){x.fn.call(x.scope||this,this.form,this,x.obj)}if(this.widgets.okButton){this.widgets.okButton.set("disabled",false)}if(this.widgets.cancelButton){this.widgets.cancelButton.set("disabled",false)}this.form.validate();this.dialog.show();Alfresco.util.caretFix(p);this.form.applyTabFix();this.widgets.escapeListener=new e(document,{keys:e.KEY.ESCAPE},{fn:function(A,z){this.hide()},scope:this,correctScope:true});this.widgets.escapeListener.enable();if(this.options.firstFocus!==null){k.get(this.options.firstFocus).focus()}},hide:function l(){if(this.dialog){this.dialog.hide()}var p=this.options.doAfterDialogHide;if(p&&typeof p.fn=="function"){p.fn.call(p.scope||this,this.form,this,p.obj)}},_hideDialog:function h(){this.dialog.hideEvent.unsubscribe(this.onHideEvent,null,this);if(this.widgets.escapeListener){this.widgets.escapeListener.disable()}var p=k.get(this.id+"-form");Alfresco.util.undoCaretFix(p);if(this.options.destroyOnHide){YAHOO.Bubbling.fire("formContainerDestroyed");YAHOO.Bubbling.unsubscribe("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this);this.dialog.destroy();delete this.dialog;delete this.widgets;if(this.isFormOwner){delete this.form}}},onHideEvent:function o(q,p){YAHOO.lang.later(0,this,this._hideDialog)},onTemplateLoaded:function g(p){var s=document.createElement("div");s.innerHTML=p.serverResponse.responseText;var r=k.getFirstChild(s);while(r&&r.tagName.toLowerCase()!="div"){r=k.getNextSibling(r)}var q={width:this.options.width};if(this.options.zIndex){q.zIndex=this.options.zIndex}this.dialog=Alfresco.util.createYUIPanel(r,q);this.dialog.hideEvent.subscribe(this.onHideEvent,null,this);if(k.get(this.id+"-form-submit")){this.isFormOwner=false;this.formsServiceDeferred.fulfil("onTemplateLoaded")}else{this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",null,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);this.isFormOwner=true;this.form=new Alfresco.forms.Form(this.id+"-form");this.form.setSubmitElements(this.widgets.okButton);this.form.setAJAXSubmit(true,{successCallback:{fn:this.onSuccess,scope:this},failureCallback:{fn:this.onFailure,scope:this}});this.form.setSubmitAsJSON(true);this.form.init();this._showDialog()}},onBeforeFormRuntimeInit:function d(q,p){var r=p[1].component,s=p[1].runtime;this.widgets.okButton=r.buttons.submit;this.widgets.okButton.set("label",this.msg("button.save"));this.widgets.okButton.set("onclick",{fn:this.onSubmit,scope:this});this.widgets.cancelButton=r.buttons.cancel;this.widgets.cancelButton.set("onclick",{fn:this.onCancel,scope:this});this.form=s;this.form.setAJAXSubmit(true,{successCallback:{fn:this.onSuccess,scope:this},failureCallback:{fn:this.onFailure,scope:this}});this.formsServiceDeferred.fulfil("onBeforeFormRuntimeInit")},onSubmit:function b(p,q){this.widgets.okButton.set("disabled",true);if(!this.form.validate()){this.widgets.okButton.set("disabled",false)}},onCancel:function i(p,q){this.hide()},onSuccess:function j(p){this.hide();if(!p){if(this.options.onFailure&&typeof this.options.onFailure.fn=="function"){this.options.onFailure.fn.call(this.options.onFailure.scope,null,this.options.onFailure.obj)}else{Alfresco.util.PopupManager.displayMessage({text:this.options.failureMessage||"Operation failed."})}}else{if(this.options.onSuccess&&typeof this.options.onSuccess.fn=="function"){this.options.onSuccess.fn.call(this.options.onSuccess.scope,p,this.options.onSuccess.obj)}else{Alfresco.util.PopupManager.displayMessage({text:this.options.successMessage||"Operation succeeded."})}}},onFailure:function n(p){this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);this.form.validate();if(typeof this.options.onFailure.fn=="function"){this.options.onFailure.fn.call(this.options.onFailure.scope,p,this.options.onFailure.obj)}else{if(p.json&&p.json.message&&p.json.status.name){Alfresco.util.PopupManager.displayPrompt({title:p.json.status.name,text:p.json.message})}else{Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:p.serverResponse})}}}});var m=new Alfresco.module.SimpleDialog("null")})();